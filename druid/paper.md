Tindex技术白皮书
==================================================

## 摘要  

Tindex是一个基于原始数据存储的多维实时分析分布式数据仓库，该系统融合了搜索引擎的索引技术，采用分布式、无共享的体系架构。  
它具有以下特性：  
* 数据实时接入，实时可查  
* 数据无损  
* 查询指标灵活定义  
* 支持上万维度   
在本文中，我们将描述Tindex的体系结构，并详细介绍Tindex如何支持快速聚合，灵活过滤，和低延迟数据接入，以及测试结果。

## 1.引言  

互联网的发展产生了大量的数据，如何存储和分析这些数据，显得越来越重要，对于技术来说，亦是挑战。目前，对于这些数据的存储分析还主要是两种方式：
一种是基于Hadoop的离线批量处理，例如Hive；另外一种是预聚合处理。  

Hadoop项目已经相当成熟，3.0的新特性更是吸引了很多人的目光，被许多组织机构或公司部署用于大规模日志数据的存储和分析。
Hadoop正在或已经帮助一些公司做大数据分析，将聚合结果转化的一系列应用(比如商业智能BI和A-B测试)都卓有成效。
具体来说，Hadoop非常擅长存储并提供大规模数据的访问。虽然Hadoop是一个高可用的系统，但它目前解决的问题还是局限在数据存储和批处理，
根本无法保证数据实时性，无法做到数据接入即可随机查询，更无法做到查询的秒级响应。  

正是由于Hadoop的局限性，为了快速的从一个个零散的数据事件的快速聚合出价值较高的结果，近几年基于OLAP的思想的预聚合系统如雨后春笋般爆发，
最典型的代表莫过于Druid和Kylin。预聚合的框架能够做到数据的实时性和快速的并发查询，但是劣势也非常明显，它所适用的模型相对固定。
预聚合的系统通常情况下是通过定义时间、维度和指标，然后按照时间粒度将维度组合作为行，在数据接入的时候实时统计每行的指标。
如此便能保证数据的实时性，但维度组合相当于将各个维度做笛卡尔积，为了保证数据的快速查询，注定行不宜过多。
为了减少预聚合的行数，维度必须裁剪，同时也不能包含高基数维度。
这些都会限制了业务的发展，一旦业务发生变更，大部分时候需要重新调整模型，已有预聚合的数据基本不可用，需要重新调整预聚合模型。  

在数果智能早起产品开发和定位的时候，我们就已经意识到了Hadoop技术非常适合作为数据存储和批处理，
随着技术的发展，预聚合框架只能作为一个辅助功能，来提升查询性能，而实际的数据分析和查询应该是基于原始数据的，指标是可以自由定制的，而不需要重新建立模型。  

基于这些考虑，数果智能结合开源的搜索引擎技术和预聚合框架重新研发了一套存储查询分析平台Tindex。一款成功的产品，需要站在巨人的肩上，数果智能研发的Tindex也不例外。选择搜索引擎技术，因为其强大的索引机制，能够满足数据筛选过滤，甚至能够应对需要分词的场景，选择预聚合的框架则是因为它的指标定义非常灵活，两者相结合，便能够满足我们所有的查询分析场景。  

关于Tindex的详细描述，我们将从以下几方面介绍：  
* Tindex的架构实现  
* Tindex存储格式和查询分析  
* 面对的挑战和发展  
* 与大数据生态圈的结合  

## 2.架构实现  

Tindex的架构设计参考了多种开源查询分析引擎，最终以一种无共享的架构来实现不同的功能点，任何节点都具有HA特性，可以根据生产环境任意启动不同的节点。我们相信这种设计分离了关注点，同时简化了整个系统的复杂性。不同的节点类型操作相对独立，并且不同的节点类型之间仅有极少的交互。因此，集群内通讯故障对数据可用性的影响微乎其微。  

为了解决复杂的数据分析问题，不同的节点类型组合在一起形成一个完成的工作体系。Tindex的架构图如下：  
![](TindexArchitecture.png)  

Tindex共有四种类型的节点，分别为：
* 容器节点：主要用于启动实时任务，实时任务为实时接入外部数据源、生成索引并提供实时查询的进程，待任务完成后，索引数据以数据段的形式上传到HDFS存储；
* 管理节点：负责分配容器节点对任务调度、关闭和运行的监控，以及统一管理系统的数据段信息；
* 历史数据节点：从HDFS下载数据段，解析数据段提供查询；
* 数据查询节点：通过数据段的元数据获取整个系统数据段的信息，包括实时任务正在处理的数据段，分解查询任务到相应的实时任务和历史数据节点，然后合并查询结果，从而统一对外提供查询服务。  

四种节点各自独立，相互配合工作。其中管理节点通过Zookeeper选举，来避免脑裂的情况出现。
Tindex被设计用于实时的接入大量日志类数据，并能够对接入的数据即席查询分析。日志类数据通常都是时间序列的，Tindex利用这一特性，在数据接入的时候，将数据分散到不同的Segment管理数据。
