Tindex技术白皮书
==================================================

## 摘要  

Tindex是一个基于原始数据存储的多维实时分析分布式数据仓库，该系统融合了搜索引擎的索引技术，采用分布式、无共享的体系架构。  
它具有以下特性：  
* 数据实时接入，实时可查  
* 数据无损  
* 查询指标灵活定义  
* 支持上万维度     

## 1 引言  

互联网的发展产生了大量的数据，如何存储和分析这些数据，显得越来越重要，对于技术来说，亦是挑战。目前，对于这些数据的存储分析还主要是两种方式：
一种是基于Hadoop的离线批量处理，例如Hive；另外一种是预聚合处理。  

Hadoop项目已经相当成熟，被许多组织机构或公司部署用于大规模日志数据的存储和分析。
Hadoop正在或已经帮助一些公司做大数据分析，将聚合结果转化的一系列应用(比如商业智能BI和A-B测试)都卓有成效。
具体来说，Hadoop非常擅长存储并提供大规模数据的访问。虽然Hadoop是一个高可用的系统，但它目前解决的问题还是局限在数据存储和批处理，
根本无法保证数据实时性，无法做到数据接入即可随机查询，更无法做到查询的秒级响应。

在数果智能早期产品开发和定位的时候，我们就已经意识到了Hadoop技术非常适合作为数据存储和批处理，
随着技术的发展，而实际的数据分析和查询应该是基于原始数据的，指标是可以自由定制的，而不需要重新建立模型。

基于这些考虑，数果智能结合开源的搜索引擎技术重新研发了一套存储查询分析平台Tindex。一款成功的产品，需要站在巨人的肩上，数果智能研发的Tindex也不例外。选择搜索引擎技术，因为其强大的索引机制，能够满足数据筛选过滤，甚至能够应对需要分词的场景，选择预聚合的框架则是因为它的指标定义非常灵活，两者相结合，便能够满足我们所有的查询分析场景。

关于Tindex的详细描述，我们将从以下几方面介绍：  
* Tindex的架构
* Tindex存储格式
* Tindex的查询分析   

## 2 架构

Tindex的架构设计参考了多种开源查询分析引擎，最终以一种无共享的架构来实现不同的功能点，任何节点都具有HA特性。不同的节点类型操作相对独立，并且不同的节点类型之间仅有极少的交互。因此，集群内通讯故障对数据可用性的影响微乎其微。另外，Tindex通过分布式文件系统保证数据文件的备份，保证数据不会丢失。

Tindex的架构图如下：  

![](TindexArchitecture.png)  

### 2.1 实时接入
Tindex可以实时地从Kafka、Metaq等分布式消息中间件接入数据。通常单进程接入速度每秒可以达到30k条消息以上，并且可以水平扩容。数据从接入到可查，延迟通常不超过5s。

在实时接入过程中，由于使用了内存索引和批事务机制，Tindex可以在不牺牲吞吐性能的前提下保障数据的一致性（不丢不重），接入性能可达某些开源框架的3倍以上。

### 2.2 高性能
对于进入Tindex的数据，会根据时间进行分片。这样在数据分析时，可以通过时间范围定位到需要的分片，减少不必要的数据扫描。而对于数据本身，Tindex会根据数据类型为数据建立列式索引，既提高了数据检索的速度，又提升了数据聚合的性能。
Tindex对于数据的读取和聚合，充分利用了mmap和向量化技术。同时不同于通用的查询引擎，Tindex针对每一类查询的技术特点，分别进行了高效的设计和实现，而这些对于用户来说都是透明的。

在实际生产环境中，Tindex可以有效支撑单机数亿乃至数百亿数据的秒级查询分析，具有极大的性能优势。

#### 2.3 高可用
对于Tindex中所有的管理节点，均提供了HA。同时对于每一个数据源，都可以根据情况配置多个数据副本。因此，任意一个节点宕机都不会导致系统失效。

#### 2.4 水平扩容
由于Tindex采用了无共享的设计和实现，当数据量急剧增加时，仅仅通过在新机器上部署服务即可实现扩容，而Tindex可以根据配置自动地完成对应的数据加载和负载均衡等工作。

## 3 存储格式
Tindex采用文件索引的形式对数据进行持久化存储，根据索引的用途，分为以下两部分：
* 倒排索引：支持数据检索
* 正向列索引：支持数据聚合

而对于索引的实现，则充分利用了字典编码等技术，大幅减少了空间大小的占用。使得Tindex中存储的数据，通常仅仅为原始数据的20%左右。
## 4 Tindex的查询分析  

Tindex的查询请求为json格式，通过http请求POST到数据查询节点，有数据查询节点转发到需要查询的节点，然后合并查询结果，最后返回json的数据格式。  

POST请求的body体是一个包含键值对(key-value pairs)JSON对象，键值对指定了不同的查询参数。一个典型的查询将需要含有数据源的名称，目标的时间范围，查询类型、过滤器和将要聚合的指标。返回结果也是一个包含有指定时间范围内的聚合后的指标的JSON对象。  
一个过滤器是一个布尔类型的维度名和值的键值对表达式。可以指定任何数字和维度组合。当提供一个过滤器，仅有属于该过滤器的子数据集才能被扫描。处理复杂嵌套过滤器的能力使得Tindex能够钻取任意深度的数据集。
具体的查询语法取决于查询类型和查询的目标信息。例如，对一周范围内的count查询如下：  

```  
{  
	"queryType": "timeseries",  
	"dataSource": "wikipedia",  
	"intervals": "2013-01-01/2013-01-08",  
	"filter": {   "type": "selector",   "Dimension": "page",   "value": "pageA"  },  
	"granularity": "day",  
	"aggregations": [{"type": "count", "name": "rows"}] 
}  
```
上述查询将会返回Wikipedia数据源中从2013-01-01到2013-01-08期间数据行的计数，查询过滤了这些数据中“page”的值等于“pageA”的数据。如下，结果将会被按天分组，并将以JSON数组的方式返回：   

```  
[
  {  
  	"timestamp": "2012-01-01T00:00:00.000Z",  
  	"result": {   "rows": 393298  } 
  }, {  
  	"timestamp": "2012-01-02T00:00:00.000Z",
  	"result": {   "rows": 382932  } 
  }, ... {  
  	"timestamp": "2012-01-07T00:00:00.000Z",  
  	"result": {   "rows": 1337  } 
  }
]

```
  
### 4.1 Tindex多样化查询

Tindex查询非常多样化：  

* Tindex支持多种数据的查询类型，普通查询有timeseries、topN、select、groupBy等，高级查询包括UserGroupQuery用于用户分组、FunnelQuery用于漏斗模型查询、RetentionQuery用于留存查询等。  
* Tindex支持多种条件过滤：日期范围，数字范围，地理坐标范围，字符串的精确匹配、正则匹配、模糊匹配、空值匹配、非空匹配、非等匹配等等。  
* Tindex支持多种聚合：  

```
 1. 统计 
　　　典型功能：sum、min、max、avg、cardinality、percent等 
 2. 分组 
　　　典型功能：直方图，分组，地理位置分区，数字分组，日期分组等 
 3. 基于聚合再聚合 
	  典型功能：每个地区平均每人的点击数 
```

### 4.2 Tindex多样的查询接口  

Tindex支持Http的方式直至Post查询的Json，另外为了便于使用，我们也研发了SQL解析引擎。SQL引擎支持两种方式的查询：  
* `RestAPI` 可以直接发送如{"sql":"select * from table1"}的json方式查询数据  
* `JDBC` Tindex支持JDBC的方式查询，只需要引入Mysql的Driver包，即可像查询Mysql一样查询Tindex


